<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <title>Patent Search (Part 1)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, Arial;
        max-width: 900px;
        margin: 24px auto;
        padding: 0 16px;
      }
      h1 {
        margin: 0 0 16px;
      }
      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      input,
      select,
      button {
        padding: 8px 10px;
        font-size: 14px;
      }
      #query {
        flex: 1 1 520px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 12px 14px;
        margin: 10px 0;
      }
      .meta {
        color: #666;
        font-size: 13px;
        margin-top: 4px;
      }
      .score {
        font-weight: 600;
      }
      .muted {
        color: #888;
      }
    </style>
  </head>
  <body>
    <h1>Patent Paragraph Search</h1>

    <div class="row">
      <input
        id="query"
        placeholder="Enter a query, such as: wheel speed sensor for vehicle"
      />
    </div>
    <div class="row">
      <label
        >TopK
        <input
          id="topk"
          type="number"
          min="1"
          max="50"
          value="5"
          style="width: 70px"
      /></label>
      <label
        >Section
        <select id="section">
          <option value="both">both</option>
          <option value="claim">claim</option>
          <option value="desc">desc</option>
        </select>
      </label>
      <label
        ><input id="use_hybrid" type="checkbox" /> Use Hybrid (BM25 +
        Vector)</label
      >
      <input
        id="bm25_weight"
        type="number"
        min="0"
        max="1"
        step="0.1"
        value="0.5"
        placeholder="bm25_weight (0~1)"
      />
      <input
        id="cpc_prefix"
        type="text"
        placeholder="CPC prefix e.g. B60B"
        style="width: 160px"
      />

      <button id="btn">Search</button>
    </div>

    <div id="results"></div>

    <script>
      const API = "http://127.0.0.1:8000/search"; // local API

      async function doSearch() {
        const query = document.getElementById("query").value.trim();
        const topk = parseInt(document.getElementById("topk").value || "5", 10);
        const section = document.getElementById("section").value;
        const useHybrid = document.getElementById("use_hybrid").checked;
        const bm25Weight = Number(
          document.getElementById("bm25_weight").value || 0.5
        );
        const cpcPrefix =
          document.getElementById("cpc_prefix").value.trim() || null;

        if (!query) {
          alert("Please enter your query first.");
          return;
        }

        document.getElementById("btn").disabled = true;
        document.getElementById("btn").innerText = "Searching...";

        try {
          const res = await fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              query,
              topk,
              section,
              cpc_prefix: cpcPrefix, // ✅ 传 CPC 前缀
              use_hybrid: useHybrid, // ✅ 开关
              bm25_weight: bm25Weight,
            }),
          });
          const data = await res.json();
          render(data, { useHybrid, bm25Weight, cpcPrefix });
        } catch (e) {
          alert("Request failed:" + e);
        } finally {
          document.getElementById("btn").disabled = false;
          document.getElementById("btn").innerText = "Search";
        }
      }

      function render(items, ctx = {}) {
        const box = document.getElementById("results");
        const { useHybrid, bm25Weight, cpcPrefix } = ctx;

        const modeLine = `
            <div class="muted" style="margin:8px 0">
              Mode: <b>${useHybrid ? "Hybrid (BM25+Vector)" : "Vector Only"}</b>
              ${useHybrid ? ` • bm25_weight=${bm25Weight}` : ""}
              ${cpcPrefix ? ` • CPC=${escapeHtml(cpcPrefix)}` : ""}
            </div>
          `;

        if (!Array.isArray(items) || items.length === 0) {
          box.innerHTML =
            modeLine +
            `<p>No results found (try a different query or remove the CPC prefix).</p>`;
          return;
        }

        const cards = items
          .map((it, i) => {
            const full = it.text_full || it.snippet || "";
            const short = full.slice(0, 220);
            const needToggle = full.length > short.length;

            return `
              <div class="card" data-i="${i}">
                <div><span class="score">#${it.rank} • ${Number(
              it.score
            ).toFixed(4)}</span>
                  • [${it.section}] ${escapeHtml(it.title)}</div>
                <div class="meta">#${it.doc_number} • cpc=${escapeHtml(
              it.classification
            )} • idx=${it.idx}</div>

                <div class="snippet" data-state="short">
                  <span class="short">${escapeHtml(short)}${
              needToggle ? "..." : ""
            }</span>
                  <span class="full" style="display:none">${escapeHtml(
                    full
                  )}</span>
                </div>

                ${
                  needToggle
                    ? `<button class="toggle" data-i="${i}" style="margin-top:6px">Show more</button>`
                    : ""
                }
              </div>`;
          })
          .join("");

        box.innerHTML = modeLine + cards;

        // 事件委托：点击 Show more / Show less
        box.onclick = (e) => {
          const btn = e.target.closest("button.toggle");
          if (!btn) return;
          const i = btn.getAttribute("data-i");
          const card = box.querySelector(`.card[data-i="${i}"]`);
          const snip = card.querySelector(".snippet");
          const shortEl = snip.querySelector(".short");
          const fullEl = snip.querySelector(".full");
          const state = snip.getAttribute("data-state");

          if (state === "short") {
            shortEl.style.display = "none";
            fullEl.style.display = "inline";
            snip.setAttribute("data-state", "full");
            btn.textContent = "Show less";
          } else {
            shortEl.style.display = "inline";
            fullEl.style.display = "none";
            snip.setAttribute("data-state", "short");
            btn.textContent = "Show more";
          }
        };
      }

      function escapeHtml(s) {
        return (s || "").replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }

      document.getElementById("btn").addEventListener("click", doSearch);
      document.getElementById("query").addEventListener("keydown", (e) => {
        if (e.key === "Enter") doSearch();
      });
    </script>
  </body>
</html>
